<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Secure File Storage</title>
  <style>
    body { font-family: system-ui, sans-serif; background: linear-gradient(135deg, #667eea, #764ba2); min-height: 100vh; padding: 2rem; color:#333; }
    .card { background:white; border-radius:12px; padding:20px; max-width:740px; margin:0 auto; box-shadow:0 10px 20px rgba(0,0,0,.1); }
    h1 { text-align:center; background:linear-gradient(135deg,#667eea,#764ba2); -webkit-background-clip:text; -webkit-text-fill-color:transparent; margin-bottom:1rem; }
    form { margin:1rem 0; display:flex; gap:.5rem; flex-wrap:wrap; }
    input, button { padding:10px; font-size:1rem; border-radius:6px; border:1px solid #ccc; }
    input[type="email"], input[type="file"] { flex:1; min-width:240px; }
    button { background:#667eea; color:white; border:none; cursor:pointer; }
    button:hover { opacity:.9; }
    ul { list-style:none; margin-top:1rem; padding:0; }
    li { display:flex; justify-content:space-between; align-items:center; padding:.5rem 0; border-bottom:1px solid #eee; gap:.5rem; }
    .name { overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .actions button { margin-left:.5rem; background:#764ba2; }
    .actions button.delete { background:#e63946; }
    .note { color:#555; font-size:.95rem; margin-top:.5rem; }
  </style>
</head>
<body>
  <div class="card">
    <h1>üîí Secure Upload Store</h1>

    <!-- Request Access -->
    <form id="reqForm">
      <input type="email" id="email" placeholder="Enter your email" required />
      <button type="submit">Request Access</button>
    </form>
    <div class="note">We‚Äôll email you a one-time sign-in link. After clicking it, this page will be authenticated via cookie.</div>

    <!-- Upload -->
    <form id="uploadForm" enctype="multipart/form-data">
      <input type="file" name="file" required />
      <button type="submit">Upload</button>
    </form>
    <div class="note">Allowed: .xlsx, .xls, .csv, .sqlite, .db (‚â§ 10MB)</div>

    <!-- File List -->
    <div style="margin-top:1rem;">
      <button id="listBtn">List Files</button>
      <button id="logoutBtn" style="background:#f59e0b;margin-left:.5rem;">Logout</button>
    </div>
    <ul id="files"></ul>
  </div>

  <script>
    const API_BASE = "/api";

    // Request magic link
    document.getElementById("reqForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const email = document.getElementById("email").value.trim();
      const r = await fetch(`${API_BASE}/request-access`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ email })
      });
      alert(r.ok ? "‚úÖ Magic link sent! Check your inbox." : "‚ùå Failed to send link");
    });

    // Upload file
    document.getElementById("uploadForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const fd = new FormData(e.target);
      const r = await fetch(`${API_BASE}/upload`, { method: "POST", body: fd, credentials: "include" });
      alert(r.ok ? "‚úÖ Uploaded!" : "‚ùå Upload failed");
      if (r.ok) refreshList();
    });

    // Logout (clear cookie by expiring it)
    document.getElementById("logoutBtn").addEventListener("click", async () => {
      // There‚Äôs no server endpoint to clear; we just expire it client-side:
      document.cookie = "auth=; Max-Age=0; path=/";
      alert("Logged out (cookie cleared).");
    });

    // List files
    document.getElementById("listBtn").addEventListener("click", refreshList);

    async function refreshList() {
      const r = await fetch(`${API_BASE}/list`, { credentials: "include" });
      if (!r.ok) {
        alert("‚ùå Not authenticated or list failed");
        return;
      }
      const files = await r.json();
      const ul = document.getElementById("files");
      ul.innerHTML = "";
      if (!files.length) {
        const li = document.createElement("li");
        li.textContent = "No files yet.";
        ul.appendChild(li);
        return;
      }
      files.forEach((f) => {
        const li = document.createElement("li");

        const name = document.createElement("div");
        name.className = "name";
        name.textContent = `${f.name} (${(f.size/1024).toFixed(1)} KB)`;
        li.appendChild(name);

        const actions = document.createElement("div");
        actions.className = "actions";

        // Download
        const dlBtn = document.createElement("button");
        dlBtn.textContent = "‚¨áÔ∏è Download";
        dlBtn.onclick = async () => {
          const res = await fetch(`${API_BASE}/download?path=${encodeURIComponent(f.path)}`, { credentials: "include" });
          if (!res.ok) return alert("‚ùå Download failed");
          const blob = await res.blob();
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = f.name || "file";
          document.body.appendChild(a);
          a.click();
          a.remove();
          window.URL.revokeObjectURL(url);
        };
        actions.appendChild(dlBtn);

        // Delete
        const delBtn = document.createElement("button");
        delBtn.textContent = "üóëÔ∏è Delete";
        delBtn.className = "delete";
        delBtn.onclick = async () => {
          if (!confirm(`Delete ${f.name}?`)) return;
          const res = await fetch(`${API_BASE}/delete?path=${encodeURIComponent(f.path)}`, {
            method: "DELETE",
            credentials: "include"
          });
          if (res.ok) {
            alert("‚úÖ Deleted");
            refreshList();
          } else {
            alert("‚ùå Delete failed");
          }
        };
        actions.appendChild(delBtn);

        li.appendChild(actions);
        ul.appendChild(li);
      });
    }

    // Optional: auto-list after page load
    // refreshList();
  </script>
</body>
</html>
